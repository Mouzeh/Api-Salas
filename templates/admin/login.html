<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Sistema de Reservas</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState } = React;
        const API_URL = '/api';

        // ================================
        // üî¥ FUNCI√ìN DE LOGOUT
        // ================================
        const handleLogout = () => {
          localStorage.removeItem('access_token');
          localStorage.removeItem('refresh_token');
          localStorage.removeItem('user');

          if (window.axios?.defaults?.headers?.common) {
            delete window.axios.defaults.headers.common['Authorization'];
          }

          window.location.href = '/login/';
        };

        // Verifica si el usuario est√° logueado
        const isAuthenticated = () => {
          return localStorage.getItem('access_token') !== null;
        };

        // ================================
        // üîµ COMPONENTE PRINCIPAL
        // ================================
        function AuthPage() {
          const [isLogin, setIsLogin] = useState(true);
          const [loading, setLoading] = useState(false);
          const [error, setError] = useState(null);
          const [success, setSuccess] = useState(null);
          
          const [loginData, setLoginData] = useState({
            email: '',
            password: ''
          });
          
          const [registerData, setRegisterData] = useState({
            username: '',
            email: '',
            password: '',
            password2: '',
            first_name: '',
            last_name: '',
            telefono: '',
            carrera: ''
          });

          const handleLogin = async () => {
            setLoading(true);
            setError(null);

            try {
              const response = await fetch(`${API_URL}/auth/login/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(loginData),
              });

              if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Credenciales incorrectas');
              }

              const data = await response.json();
              
              localStorage.setItem('access_token', data.access);
              localStorage.setItem('refresh_token', data.refresh);
              localStorage.setItem('user', JSON.stringify(data.user));

              setSuccess('¬°Inicio de sesi√≥n exitoso! Redirigiendo...');

              setTimeout(() => {
                fetch('/set-session/', {
                    method: 'POST',
                    headers: {
                      'Content-Type': 'application/json',
                      'Authorization': `Bearer ${data.access}`
                    }
                }).then(() => {
                    window.location.href = data.user.es_admin
                        ? '/admin-dashboard/'
                        : '/cliente-dashboard/';
                });
              }, 1200);

            } catch (err) {
              setError(err.message);
            } finally {
              setLoading(false);
            }
          };

          const handleRegister = async () => {
            setLoading(true);
            setError(null);

            if (registerData.password !== registerData.password2) {
              setError('Las contrase√±as no coinciden');
              setLoading(false);
              return;
            }

            try {
              const response = await fetch(`${API_URL}/auth/registro/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(registerData),
              });

              if (!response.ok) {
                const errorData = await response.json();
                const errorMsg = Object.values(errorData).flat().join(', ');
                throw new Error(errorMsg || 'Error al registrarse');
              }

              setSuccess('¬°Registro exitoso! Ahora puedes iniciar sesi√≥n.');
              
              setTimeout(() => {
                setIsLogin(true);
                setSuccess(null);
                setLoginData(prev => ({ ...prev, email: registerData.email }));
              }, 2000);

            } catch (err) {
              setError(err.message);
            } finally {
              setLoading(false);
            }
          };

          return (
            <div className="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 flex items-center justify-center p-4">
              <div className="w-full max-w-md">

                {/* LOGO */}
                <div className="text-center mb-8">
                  <div className="inline-flex items-center justify-center w-20 h-20 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full mb-4 shadow-lg">
                    <i className="fas fa-calendar-alt text-4xl text-white"></i>
                  </div>
                  <h1 className="text-3xl font-bold text-white mb-2">Sistema de Reservas</h1>
                  <p className="text-blue-200">Gesti√≥n de salas de estudio</p>
                </div>

                {/* üëá BOT√ìN DE LOGOUT SI EST√Å AUTENTICADO */}
                {isAuthenticated() && (
                  <div className="text-center mb-6">
                    <button
                      onClick={handleLogout}
                      className="bg-gradient-to-r from-red-600 to-red-800 text-white px-5 py-2 rounded-lg font-semibold inline-flex items-center gap-2 shadow-lg hover:opacity-90 transition"
                    >
                      <i className="fas fa-sign-out-alt"></i>
                      Cerrar Sesi√≥n
                    </button>
                  </div>
                )}

                {/* ERRORES */}
                {error && (
                  <div className="mb-4 bg-red-500/10 border border-red-500 text-red-200 px-4 py-3 rounded-lg flex items-center gap-2">
                    <i className="fas fa-exclamation-circle"></i>
                    <span>{error}</span>
                  </div>
                )}

                {/* √âXITO */}
                {success && (
                  <div className="mb-4 bg-green-500/10 border border-green-500 text-green-200 px-4 py-3 rounded-lg flex items-center gap-2">
                    <i className="fas fa-check-circle"></i>
                    <span>{success}</span>
                  </div>
                )}

                {/* CAJA PRINCIPAL */}
                <div className="bg-slate-800/90 backdrop-blur-lg rounded-2xl shadow-2xl border border-slate-700 overflow-hidden">
                  <div className="flex border-b border-slate-700">
                    <button
                      onClick={() => { setIsLogin(true); setError(null); setSuccess(null); }}
                      className={`flex-1 py-4 px-6 font-semibold transition ${isLogin ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                    >
                      <i className="fas fa-sign-in-alt mr-2"></i>
                      Iniciar Sesi√≥n
                    </button>

                    <button
                      onClick={() => { setIsLogin(false); setError(null); setSuccess(null); }}
                      className={`flex-1 py-4 px-6 font-semibold transition ${!isLogin ? 'bg-blue-600 text-white' : 'text-slate-400 hover:text-white'}`}
                    >
                      <i className="fas fa-user-plus mr-2"></i>
                      Registrarse
                    </button>
                  </div>

                  <div className="p-8">
                    {isLogin ? (
                      <div className="space-y-5">
                        <div>
                          <label className="block text-sm font-medium text-slate-300 mb-2">
                            <i className="fas fa-envelope mr-2"></i> Correo Electr√≥nico
                          </label>
                          <input
                            type="email"
                            value={loginData.email}
                            onChange={(e) => setLoginData({...loginData, email: e.target.value})}
                            className="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white"
                            placeholder="tu@email.com"
                          />
                        </div>

                        <div>
                          <label className="block text-sm font-medium text-slate-300 mb-2">
                            <i className="fas fa-lock mr-2"></i> Contrase√±a
                          </label>
                          <input
                            type="password"
                            value={loginData.password}
                            onChange={(e) => setLoginData({...loginData, password: e.target.value})}
                            onKeyPress={(e) => e.key === 'Enter' && handleLogin()}
                            className="w-full px-4 py-3 bg-slate-900 border border-slate-700 rounded-lg text-white"
                            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                          />
                        </div>

                        <button
                          onClick={handleLogin}
                          disabled={loading}
                          className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg"
                        >
                          {loading ? 'Iniciando sesi√≥n...' : 'Iniciar Sesi√≥n'}
                        </button>

                      </div>
                    ) : (
                      <div className="space-y-4">

                        <div className="grid grid-cols-2 gap-4">
                          <input className="input" placeholder="Nombre"
                            value={registerData.first_name}
                            onChange={(e) => setRegisterData({...registerData, first_name: e.target.value})} />
                          <input className="input" placeholder="Apellido"
                            value={registerData.last_name}
                            onChange={(e) => setRegisterData({...registerData, last_name: e.target.value})} />
                        </div>

                        <input className="input" placeholder="Usuario"
                          value={registerData.username}
                          onChange={(e) => setRegisterData({...registerData, username: e.target.value})} />

                        <input className="input" placeholder="Email"
                          type="email"
                          value={registerData.email}
                          onChange={(e) => setRegisterData({...registerData, email: e.target.value})} />

                        <input className="input" placeholder="Tel√©fono"
                          value={registerData.telefono}
                          onChange={(e) => setRegisterData({...registerData, telefono: e.target.value})} />

                        <input className="input" placeholder="Carrera"
                          value={registerData.carrera}
                          onChange={(e) => setRegisterData({...registerData, carrera: e.target.value})} />

                        <input className="input" placeholder="Contrase√±a" type="password"
                          value={registerData.password}
                          onChange={(e) => setRegisterData({...registerData, password: e.target.value})} />

                        <input className="input" placeholder="Repetir Contrase√±a" type="password"
                          onKeyPress={(e) => e.key === 'Enter' && handleRegister()}
                          value={registerData.password2}
                          onChange={(e) => setRegisterData({...registerData, password2: e.target.value})} />

                        <button
                          onClick={handleRegister}
                          disabled={loading}
                          className="w-full py-3 bg-gradient-to-r from-blue-600 to-purple-600 text-white font-semibold rounded-lg"
                        >
                          {loading ? 'Registrando...' : 'Crear Cuenta'}
                        </button>
                      </div>
                    )}
                  </div>
                </div>

                <div className="text-center mt-6 text-slate-400 text-sm">
                  <p>Sistema de Reservas ¬© 2024</p>
                  <a href="/" className="text-blue-400 hover:text-blue-300 mt-2 inline-block">
                    ‚Üê Volver al inicio
                  </a>
                </div>

              </div>
            </div>
          );
        }

        // RENDER
        ReactDOM.render(<AuthPage />, document.getElementById('root'));
    </script>
</body>
</html>
