<!-- Archivo: templates/cliente/dashboard.html -->
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Cliente - Sistema de Reservas</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/cliente.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <h1><i class="fas fa-calendar-alt"></i> Dashboard Cliente</h1>
            <p class="subtitle">Gestión de tus reservas de salas de estudio</p>
        </header>

        <!-- Tabs de Navegación -->
        <div class="tabs-container">
            <div class="tabs">
                <button class="tab active" data-tab="mis-reservas">
                    <i class="fas fa-calendar-check"></i> Mis Reservas
                </button>
                <button class="tab" data-tab="reservar">
                    <i class="fas fa-plus-circle"></i> Nueva Reserva
                </button>
                <button class="tab" data-tab="salas-disponibles">
                    <i class="fas fa-door-open"></i> Salas Disponibles
                </button>
                <button class="tab" data-tab="mi-perfil">
                    <i class="fas fa-user-circle"></i> Mi Perfil
                </button>
                <div style="flex: 1"></div>
                <button class="btn btn-secondary" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
                </button>
            </div>
        </div>

        <!-- Contenido Principal -->
        <main class="main-content">
            <!-- Mensajes -->
            <div id="alert-container"></div>

            <!-- Tab: Mis Reservas -->
            <div id="mis-reservas" class="tab-content active">
                <h2 class="section-title">
                    <i class="fas fa-calendar-check"></i> Mis Reservas
                </h2>
                
                <!-- Filtros -->
                <div class="header-actions">
                    <div class="filters">
                        <select id="filter-estado" class="form-control" style="width: 200px;">
                            <option value="todos">Todas las reservas</option>
                            <option value="pendiente">Pendientes</option>
                            <option value="confirmada">Confirmadas</option>
                            <option value="cancelada">Canceladas</option>
                        </select>
                        <select id="filter-fecha" class="form-control" style="width: 200px;">
                            <option value="todos">Todas las fechas</option>
                            <option value="hoy">Hoy</option>
                            <option value="futuro">Próximas</option>
                            <option value="pasado">Pasadas</option>
                        </select>
                        <button id="refresh-btn" class="btn btn-secondary">
                            <i class="fas fa-sync-alt"></i> Actualizar
                        </button>
                    </div>
                </div>

                <!-- Lista de Reservas -->
                <div id="reservas-list" class="reservas-container">
                    <!-- Se llenará dinámicamente con JavaScript -->
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>No tienes reservas aún</h3>
                        <p>¡Empieza a reservar salas ahora mismo!</p>
                        <button class="btn btn-primary mt-4" data-tab="reservar">
                            <i class="fas fa-plus-circle"></i> Crear mi primera reserva
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab: Nueva Reserva -->
            <div id="reservar" class="tab-content">
                <h2 class="section-title">
                    <i class="fas fa-plus-circle"></i> Nueva Reserva
                </h2>
                
                <div class="reserva-form">
                    <form id="nueva-reserva-form">
                        <div class="form-row">
                            <div class="form-group">
                                <label for="sala">
                                    <i class="fas fa-door-open"></i> Sala *
                                </label>
                                <select id="sala" name="sala" class="form-control" required>
                                    <option value="">Seleccionar sala...</option>
                                    <!-- Se llenará dinámicamente -->
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="fecha">
                                    <i class="fas fa-calendar"></i> Fecha *
                                </label>
                                <input type="date" id="fecha" name="fecha" class="form-control" required>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="hora_inicio">
                                    <i class="fas fa-clock"></i> Hora Inicio *
                                </label>
                                <input type="time" id="hora_inicio" name="hora_inicio" 
                                       class="form-control" min="08:00" max="22:00" required>
                            </div>
                            
                            <div class="form-group">
                                <label for="hora_fin">
                                    <i class="fas fa-clock"></i> Hora Fin *
                                </label>
                                <input type="time" id="hora_fin" name="hora_fin" 
                                       class="form-control" min="08:00" max="22:00" required>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="motivo_uso">
                                <i class="fas fa-comment-alt"></i> Motivo de uso *
                            </label>
                            <textarea id="motivo_uso" name="motivo_uso" class="form-control" 
                                      rows="4" placeholder="Describe el propósito de la reserva..." required></textarea>
                            <small class="form-text">Ej: Estudio grupal, Reunión de proyecto, Preparación de examen, etc.</small>
                        </div>

                        <div class="form-info">
                            <div class="info-box">
                                <i class="fas fa-info-circle"></i>
                                <p>La duración máxima es de 4 horas. Horario disponible: 08:00 - 22:00</p>
                            </div>
                        </div>

                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-check-circle"></i> Crear Reserva
                            </button>
                            <button type="button" class="btn btn-secondary" data-tab="mis-reservas">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Tab: Salas Disponibles -->
            <div id="salas-disponibles" class="tab-content">
                <h2 class="section-title">
                    <i class="fas fa-door-open"></i> Salas Disponibles
                </h2>
                
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-salas" placeholder="Buscar sala por nombre o ubicación..." 
                               class="form-control" style="width: 300px;">
                    </div>
                </div>

                <div id="salas-grid" class="salas-grid">
                    <!-- Se llenará dinámicamente -->
                </div>
            </div>

            <!-- Tab: Mi Perfil -->
            <div id="mi-perfil" class="tab-content">
                <h2 class="section-title">
                    <i class="fas fa-user-circle"></i> Mi Perfil
                </h2>
                
                <div class="profile-container">
                    <div class="profile-card">
                        <div class="profile-header">
                            <div class="profile-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="profile-info">
                                <h3 id="profile-name">Cargando...</h3>
                                <p id="profile-email">Cargando...</p>
                                <span class="badge usuario">Usuario Regular</span>
                            </div>
                        </div>

                        <div class="profile-details">
                            <div class="detail-item">
                                <strong><i class="fas fa-graduation-cap"></i> Carrera:</strong>
                                <span id="profile-carrera">Cargando...</span>
                            </div>
                            <div class="detail-item">
                                <strong><i class="fas fa-phone"></i> Teléfono:</strong>
                                <span id="profile-telefono">Cargando...</span>
                            </div>
                            <div class="detail-item">
                                <strong><i class="fas fa-calendar-alt"></i> Miembro desde:</strong>
                                <span id="profile-fecha-registro">Cargando...</span>
                            </div>
                            <div class="detail-item">
                                <strong><i class="fas fa-calendar-check"></i> Reservas totales:</strong>
                                <span id="profile-total-reservas">0</span>
                            </div>
                        </div>

                        <div class="profile-actions">
                            <button class="btn btn-primary" id="edit-profile-btn">
                                <i class="fas fa-edit"></i> Editar Perfil
                            </button>
                            <button class="btn btn-secondary" id="change-password-btn">
                                <i class="fas fa-lock"></i> Cambiar Contraseña
                            </button>
                        </div>
                    </div>

                    <!-- Estadísticas -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon confirmada">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <div class="stat-content">
                                <h4>Reservas Confirmadas</h4>
                                <p class="stat-number" id="stats-confirmadas">0</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon pendiente">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="stat-content">
                                <h4>Reservas Pendientes</h4>
                                <p class="stat-number" id="stats-pendientes">0</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon cancelada">
                                <i class="fas fa-times-circle"></i>
                            </div>
                            <div class="stat-content">
                                <h4>Reservas Canceladas</h4>
                                <p class="stat-number" id="stats-canceladas">0</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon total">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                            <div class="stat-content">
                                <h4>Total Horas Reservadas</h4>
                                <p class="stat-number" id="stats-total-horas">0h</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="app-footer">
            <p>Sistema de Reservas de Salas - Universidad © 2024</p>
            <p>Cliente: <span id="user-email-display">Usuario</span></p>
        </footer>
    </div>

    <!-- Modal para Detalles/Edición -->
    <div id="reserva-modal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2><i class="fas fa-calendar-alt"></i> Detalles de Reserva</h2>
                <button class="modal-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Contenido dinámico -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close">Cerrar</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Datos del usuario (se cargarán del localStorage o API)
        let currentUser = null;
        let token = localStorage.getItem('access_token');

        // Verificar autenticación
        if (!token) {
            window.location.href = '/login/';
        }

        // Navegación entre tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                // Actualizar tabs activos
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Mostrar contenido correspondiente
                const tabId = this.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
            });
        });

        // Botones que cambian de tab
        document.querySelectorAll('[data-tab]').forEach(btn => {
            btn.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                document.querySelector(`[data-tab="${tabId}"]`).click();
            });
        });

        // Cerrar sesión
        document.getElementById('logout-btn').addEventListener('click', function() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('user');
            window.location.href = '/login/';
        });

        // Cargar datos del usuario
        async function loadUserData() {
            try {
                const response = await fetch('/api/usuarios/me/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar usuario');
                
                currentUser = await response.json();
                
                // Actualizar UI
                document.getElementById('profile-name').textContent = currentUser.nombre_completo;
                document.getElementById('profile-email').textContent = currentUser.email;
                document.getElementById('profile-carrera').textContent = currentUser.carrera;
                document.getElementById('profile-telefono').textContent = currentUser.telefono;
                document.getElementById('profile-fecha-registro').textContent = 
                    new Date(currentUser.fecha_registro).toLocaleDateString('es-CL');
                document.getElementById('user-email-display').textContent = currentUser.email;
                document.getElementById('profile-total-reservas').textContent = currentUser.total_reservas;
                
            } catch (error) {
                showAlert('Error al cargar datos del usuario', 'error');
            }
        }

        // Cargar reservas del usuario
        async function loadUserReservas() {
            try {
                const response = await fetch('/api/reservas/mis_reservas/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar reservas');
                
                const reservas = await response.json();
                displayReservas(reservas);
                updateStats(reservas);
                
            } catch (error) {
                showAlert('Error al cargar reservas', 'error');
            }
        }

        // Cargar salas disponibles
        async function loadSalasDisponibles() {
            try {
                const response = await fetch('/api/salas/disponibles/', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar salas');
                
                const salas = await response.json();
                displaySalas(salas);
                populateSalaSelect(salas);
                
            } catch (error) {
                showAlert('Error al cargar salas', 'error');
            }
        }

        // Mostrar reservas en la lista
        function displayReservas(reservas) {
            const container = document.getElementById('reservas-list');
            
            if (reservas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-calendar-alt"></i>
                        <h3>No tienes reservas aún</h3>
                        <p>¡Empieza a reservar salas ahora mismo!</p>
                        <button class="btn btn-primary mt-4" data-tab="reservar">
                            <i class="fas fa-plus-circle"></i> Crear mi primera reserva
                        </button>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = reservas.map(reserva => `
                <div class="reserva-card ${reserva.estado}">
                    <div class="reserva-header">
                        <h3>${reserva.sala_nombre}</h3>
                        <span class="badge ${reserva.estado}">${reserva.estado}</span>
                    </div>
                    
                    <div class="reserva-info-grid">
                        <div class="reserva-info-item">
                            <strong><i class="fas fa-calendar"></i> Fecha</strong>
                            <span>${reserva.fecha}</span>
                        </div>
                        <div class="reserva-info-item">
                            <strong><i class="fas fa-clock"></i> Horario</strong>
                            <span>${reserva.hora_inicio} - ${reserva.hora_fin}</span>
                        </div>
                        <div class="reserva-info-item">
                            <strong><i class="fas fa-map-marker-alt"></i> Ubicación</strong>
                            <span>${reserva.sala_ubicacion || 'No especificada'}</span>
                        </div>
                    </div>
                    
                    <div class="reserva-actions">
                        ${reserva.estado === 'pendiente' ? `
                            <button class="btn btn-success" onclick="confirmarReserva(${reserva.id})">
                                <i class="fas fa-check"></i> Confirmar
                            </button>
                            <button class="btn btn-danger" onclick="cancelarReserva(${reserva.id})">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        ` : ''}
                        
                        ${reserva.estado === 'confirmada' ? `
                            <button class="btn btn-danger" onclick="cancelarReserva(${reserva.id})">
                                <i class="fas fa-times"></i> Cancelar
                            </button>
                        ` : ''}
                        
                        <button class="btn btn-secondary" onclick="verDetallesReserva(${reserva.id})">
                            <i class="fas fa-eye"></i> Ver Detalles
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Mostrar salas disponibles
        function displaySalas(salas) {
            const container = document.getElementById('salas-grid');
            
            if (salas.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-door-closed"></i>
                        <h3>No hay salas disponibles</h3>
                        <p>Intenta nuevamente más tarde</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = salas.map(sala => `
                <div class="sala-card">
                    <h3>${sala.nombre} 
                        <span class="badge disponible">Disponible</span>
                    </h3>
                    
                    <div class="sala-info">
                        <div class="info-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span>${sala.ubicacion}</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-users"></i>
                            <span>Capacidad: ${sala.capacidad} personas</span>
                        </div>
                        <div class="info-item">
                            <i class="fas fa-tools"></i>
                            <span>Equipamiento: ${sala.equipamiento || 'Básico'}</span>
                        </div>
                    </div>
                    
                    <div class="sala-actions">
                        <button class="btn btn-primary w-100" onclick="reservarSala(${sala.id})" data-tab="reservar">
                            <i class="fas fa-calendar-plus"></i> Reservar esta sala
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Llenar select de salas en formulario
        function populateSalaSelect(salas) {
            const select = document.getElementById('sala');
            select.innerHTML = '<option value="">Seleccionar sala...</option>' +
                salas.map(sala => `
                    <option value="${sala.id}">
                        ${sala.nombre} (Capacidad: ${sala.capacidad}, ${sala.ubicacion})
                    </option>
                `).join('');
        }

        // Actualizar estadísticas
        function updateStats(reservas) {
            const confirmadas = reservas.filter(r => r.estado === 'confirmada').length;
            const pendientes = reservas.filter(r => r.estado === 'pendiente').length;
            const canceladas = reservas.filter(r => r.estado === 'cancelada').length;
            
            // Calcular total horas (simplificado)
            const totalHoras = reservas.reduce((total, reserva) => {
                if (reserva.duracion_horas) {
                    return total + reserva.duracion_horas;
                }
                return total;
            }, 0);
            
            document.getElementById('stats-confirmadas').textContent = confirmadas;
            document.getElementById('stats-pendientes').textContent = pendientes;
            document.getElementById('stats-canceladas').textContent = canceladas;
            document.getElementById('stats-total-horas').textContent = `${totalHoras}h`;
        }

        // Mostrar alerta
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : 'check-circle'}"></i>
                ${message}
            `;
            container.appendChild(alert);
            
            setTimeout(() => alert.remove(), 5000);
        }

        // Confirmar reserva
        async function confirmarReserva(reservaId) {
            if (!confirm('¿Confirmar esta reserva?')) return;
            
            try {
                const response = await fetch(`/api/reservas/${reservaId}/confirmar/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Error al confirmar reserva');
                
                showAlert('Reserva confirmada exitosamente', 'success');
                loadUserReservas();
                
            } catch (error) {
                showAlert('Error al confirmar reserva', 'error');
            }
        }

        // Cancelar reserva
        async function cancelarReserva(reservaId) {
            if (!confirm('¿Cancelar esta reserva?')) return;
            
            try {
                const response = await fetch(`/api/reservas/${reservaId}/cancelar/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) throw new Error('Error al cancelar reserva');
                
                showAlert('Reserva cancelada exitosamente', 'success');
                loadUserReservas();
                
            } catch (error) {
                showAlert('Error al cancelar reserva', 'error');
            }
        }

        // Ver detalles de reserva
        async function verDetallesReserva(reservaId) {
            try {
                const response = await fetch(`/api/reservas/${reservaId}/`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) throw new Error('Error al cargar detalles');
                
                const reserva = await response.json();
                showReservaModal(reserva);
                
            } catch (error) {
                showAlert('Error al cargar detalles', 'error');
            }
        }

        // Mostrar modal de reserva
        function showReservaModal(reserva) {
            const modal = document.getElementById('reserva-modal');
            const modalBody = modal.querySelector('.modal-body');
            
            modalBody.innerHTML = `
                <div class="modal-reserva-details">
                    <h3>${reserva.sala_nombre}</h3>
                    
                    <div class="detail-grid">
                        <div class="detail-item">
                            <strong>Estado:</strong>
                            <span class="badge ${reserva.estado}">${reserva.estado}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Fecha:</strong>
                            <span>${reserva.fecha}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Horario:</strong>
                            <span>${reserva.hora_inicio} - ${reserva.hora_fin}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Duración:</strong>
                            <span>${reserva.duracion_horas || 'N/A'} horas</span>
                        </div>
                        <div class="detail-item">
                            <strong>Ubicación:</strong>
                            <span>${reserva.sala_ubicacion || 'No especificada'}</span>
                        </div>
                        <div class="detail-item">
                            <strong>Usuario:</strong>
                            <span>${reserva.usuario_nombre}</span>
                        </div>
                        <div class="detail-item full-width">
                            <strong>Motivo de uso:</strong>
                            <p>${reserva.motivo_uso}</p>
                        </div>
                        <div class="detail-item">
                            <strong>Creada el:</strong>
                            <span>${new Date(reserva.fecha_creacion).toLocaleString('es-CL')}</span>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.add('active');
        }

        // Reservar sala desde la lista
        function reservarSala(salaId) {
            // Cambiar a pestaña de reserva
            document.querySelector('[data-tab="reservar"]').click();
            
            // Seleccionar la sala en el formulario
            setTimeout(() => {
                document.getElementById('sala').value = salaId;
            }, 100);
        }

        // Enviar nueva reserva
        document.getElementById('nueva-reserva-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                sala: document.getElementById('sala').value,
                fecha: document.getElementById('fecha').value,
                hora_inicio: document.getElementById('hora_inicio').value,
                hora_fin: document.getElementById('hora_fin').value,
                motivo_uso: document.getElementById('motivo_uso').value
            };
            
            // Validaciones básicas
            if (formData.hora_fin <= formData.hora_inicio) {
                showAlert('La hora de fin debe ser posterior a la hora de inicio', 'error');
                return;
            }
            
            const fechaReserva = new Date(formData.fecha);
            const hoy = new Date();
            hoy.setHours(0, 0, 0, 0);
            
            if (fechaReserva < hoy) {
                showAlert('No se pueden hacer reservas en fechas pasadas', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/reservas/', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || JSON.stringify(data));
                }
                
                showAlert('¡Reserva creada exitosamente!', 'success');
                this.reset();
                
                // Actualizar lista de reservas
                loadUserReservas();
                
                // Cambiar a pestaña de mis reservas
                document.querySelector('[data-tab="mis-reservas"]').click();
                
            } catch (error) {
                showAlert('Error al crear reserva: ' + error.message, 'error');
            }
        });

        // Filtros
        document.getElementById('filter-estado').addEventListener('change', function() {
            // Implementar filtrado en el cliente
            console.log('Filtrar por estado:', this.value);
        });

        document.getElementById('filter-fecha').addEventListener('change', function() {
            // Implementar filtrado en el cliente
            console.log('Filtrar por fecha:', this.value);
        });

        // Búsqueda de salas
        document.getElementById('search-salas').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            const salasCards = document.querySelectorAll('.sala-card');
            
            salasCards.forEach(card => {
                const nombre = card.querySelector('h3').textContent.toLowerCase();
                const ubicacion = card.querySelector('.info-item:nth-child(1) span').textContent.toLowerCase();
                
                if (nombre.includes(searchTerm) || ubicacion.includes(searchTerm)) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });

        // Botón de actualizar
        document.getElementById('refresh-btn').addEventListener('click', function() {
            loadUserReservas();
            showAlert('Datos actualizados', 'success');
        });

        // Cerrar modales
        document.querySelectorAll('.modal-close, .modal-overlay').forEach(element => {
            element.addEventListener('click', function() {
                document.getElementById('reserva-modal').classList.remove('active');
            });
        });

        // Prevenir cierre del modal al hacer clic dentro
        document.querySelector('.modal').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        // Configurar fecha mínima (hoy)
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('fecha').min = today;

        // Cargar datos iniciales
        window.addEventListener('DOMContentLoaded', async () => {
            await Promise.all([
                loadUserData(),
                loadUserReservas(),
                loadSalasDisponibles()
            ]);
            
            // Programar actualizaciones periódicas (cada 30 segundos)
            setInterval(() => {
                if (document.getElementById('mis-reservas').classList.contains('active')) {
                    loadUserReservas();
                }
                if (document.getElementById('salas-disponibles').classList.contains('active')) {
                    loadSalasDisponibles();
                }
            }, 30000);
        });

        // Manejar token expirado
        async function refreshToken() {
            try {
                const refresh = localStorage.getItem('refresh_token');
                const response = await fetch('/api/auth/refresh/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ refresh })
                });
                
                if (!response.ok) throw new Error('Token refresh failed');
                
                const data = await response.json();
                localStorage.setItem('access_token', data.access);
                token = data.access;
                
            } catch (error) {
                // Si el refresh también falla, redirigir al login
                localStorage.removeItem('access_token');
                localStorage.removeItem('refresh_token');
                localStorage.removeItem('user');
                window.location.href = '/login/';
            }
        }

        // Interceptor para manejar token expirado
        const originalFetch = window.fetch;
        window.fetch = async function(...args) {
            let response = await originalFetch.apply(this, args);
            
            if (response.status === 401) {
                await refreshToken();
                args[1] = args[1] || {};
                args[1].headers = {
                    ...args[1].headers,
                    'Authorization': `Bearer ${token}`
                };
                response = await originalFetch.apply(this, args);
            }
            
            return response;
        };
    </script>
</body>
</html>